---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import { formatDate } from '@utils/date';

interface Props {
  currentPost: any;
  limit?: number;
}

const { currentPost, limit = 3 } = Astro.props;
const allPosts = await getCollection('posts');
const otherPosts = allPosts.filter(post => post.slug !== currentPost.slug);

function getRelatedPosts(current: any, posts: any[], max: number) {
  const currentTags = current.data.tags || [];
  const currentCategories = current.data.categories || [];
  
  // Score posts by relevance
  const scored = posts.map(post => {
    const postTags = post.data.tags || [];
    const postCategories = post.data.categories || [];
    const tagMatches = currentTags.filter((t: string) => postTags.includes(t)).length;
    const catMatches = currentCategories.filter((c: string) => postCategories.includes(c)).length;
    return { post, score: tagMatches * 2 + catMatches };
  });
  
  // Sort by score, then randomize ties
  return scored
    .sort((a, b) => b.score - a.score || Math.random() - 0.5)
    .slice(0, max)
    .map(s => s.post);
}

const relatedPosts = getRelatedPosts(currentPost, otherPosts, limit);
---

<section class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
  <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Related Posts</h2>
  
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {relatedPosts.map((post) => (
      <article class="group bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
        {post.data.image && (
          <a href={`/${post.slug}/`} class="block aspect-video overflow-hidden">
            <Image 
              src={post.data.image} 
              alt={post.data.title} 
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              width={400}
              height={225}
              loading="lazy"
              decoding="async"
            />
          </a>
        )}
        
        <div class="p-4">
          {post.data.categories?.[0] && (
            <a href={`/categories/${post.data.categories[0].toLowerCase()}/`} class="text-xs font-medium px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full">
              {post.data.categories[0]}
            </a>
          )}
          
          <h3 class="mt-2 text-lg font-bold text-gray-900 dark:text-white line-clamp-2">
            <a href={`/${post.slug}/`} class="hover:text-blue-600 dark:hover:text-blue-400">
              {post.data.title}
            </a>
          </h3>
          
          {post.data.date && (
            <time class="text-sm text-gray-500 dark:text-gray-400 mt-2 block" datetime={post.data.date.toISOString()}>
              {formatDate(post.data.date)}
            </time>
          )}
        </div>
      </article>
    ))}
  </div>
</section>
