---
import ThemeToggle from "./ThemeToggle.astro";
import { Image } from "astro:assets";
import menu from "@config/menu.json";
import { siteConfig } from "@config/site";
import logoSVG from "@assets/favicons/bitdoze_logo_better.svg";

const mainMenu = menu.main;
const currentPath = Astro.url.pathname;
---

<header class="sticky top-0 z-50 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 shadow-sm">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <a href="/" class="flex-shrink-0">
        <Image src={logoSVG} alt={siteConfig.title} width={140} height={140} />
      </a>

      <!-- Mobile menu button -->
      <button 
        type="button" 
        id="mobile-menu-btn"
        class="md:hidden p-2 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
        aria-controls="mobile-menu" 
        aria-expanded="false"
        aria-label="Toggle menu"
      >
        <svg class="menu-icon h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg class="close-icon hidden h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Desktop nav -->
      <nav class="hidden md:flex items-center gap-1">
        {mainMenu.map((item) => (
          item.hasChildren ? (
            <div class="relative group">
              <button class="nav-link flex items-center gap-1" aria-haspopup="true">
                {item.name}
                <svg class="h-4 w-4 transition-transform group-hover:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="absolute left-0 top-full pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg py-2 min-w-[180px]">
                  {item.children.map((child) => (
                    <a href={child.url} class="block px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700">
                      {child.name}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <a href={item.url} class={`nav-link ${currentPath === item.url || currentPath.startsWith(item.url + '/') ? 'active' : ''}`}>
              {item.name}
            </a>
          )
        ))}
        <a href="/search/" class="p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" aria-label="Search">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </a>
        <ThemeToggle />
      </nav>
    </div>
  </div>

  <!-- Mobile menu -->
  <nav id="mobile-menu" class="hidden md:hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
    <div class="px-4 py-3 space-y-1">
      {mainMenu.map((item) => (
        item.hasChildren ? (
          <div class="mobile-dropdown">
            <button class="mobile-dropdown-btn w-full flex justify-between items-center py-2 text-gray-600 dark:text-gray-300">
              {item.name}
              <svg class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            <div class="mobile-dropdown-content hidden pl-4 space-y-1">
              {item.children.map((child) => (
                <a href={child.url} class="block py-2 text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400">
                  {child.name}
                </a>
              ))}
            </div>
          </div>
        ) : (
          <a href={item.url} class={`block py-2 text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 ${currentPath === item.url ? 'text-blue-600 dark:text-blue-400' : ''}`}>
            {item.name}
          </a>
        )
      ))}
      <div class="flex items-center gap-4 pt-3 border-t border-gray-200 dark:border-gray-700">
        <a href="/search/" class="p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" aria-label="Search">
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </a>
        <ThemeToggle />
      </div>
    </div>
  </nav>
</header>

<style>
  .nav-link {
    position: relative;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: rgb(107 114 128);
    transition: color 0.2s;
  }
  
  .nav-link:hover,
  .nav-link.active {
    color: rgb(37 99 235);
  }
  
  :global(.dark) .nav-link {
    color: rgb(156 163 175);
  }
  
  :global(.dark) .nav-link:hover,
  :global(.dark) .nav-link.active {
    color: rgb(96 165 250);
  }
  
  .nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0.75rem;
    right: 0.75rem;
    height: 2px;
    background: rgb(37 99 235);
    transform: scaleX(0);
    transition: transform 0.2s ease;
  }
  
  :global(.dark) .nav-link::after {
    background: rgb(96 165 250);
  }
  
  .nav-link:hover::after,
  .nav-link.active::after {
    transform: scaleX(1);
  }
</style>

<script>
  const btn = document.getElementById('mobile-menu-btn');
  const menu = document.getElementById('mobile-menu');
  const menuIcon = btn?.querySelector('.menu-icon');
  const closeIcon = btn?.querySelector('.close-icon');

  btn?.addEventListener('click', () => {
    const isOpen = menu?.classList.toggle('hidden') === false;
    btn.setAttribute('aria-expanded', String(isOpen));
    menuIcon?.classList.toggle('hidden', isOpen);
    closeIcon?.classList.toggle('hidden', !isOpen);
  });

  document.querySelectorAll('.mobile-dropdown-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const content = btn.nextElementSibling;
      const icon = btn.querySelector('svg');
      content?.classList.toggle('hidden');
      icon?.classList.toggle('rotate-180');
    });
  });
</script>
